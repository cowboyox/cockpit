#!/bin/sh

set -eu

if [ -t 2 ]; then
    red="\e[1;31m"
    green="\e[1;32m"
    blue="\e[1;34m"
    grey="\e[0m"
else
    red=""
    green=""
    blue=""
    grey=""
fi

post_commit_hook="$(realpath -m "$0"/../git-hook-post-commit)"
nothing='0000000000000000000000000000000000000000'
fail=''

# cf. man 5 githooks
# <local ref> SP <local object name> SP <remote ref> SP <remote object name> LF
while read local_ref local_object_name remote_ref remote_object_name; do
    printf "${blue}Performing pre-push checks for %s:${grey}\n" "${remote_ref}" >&2

    if [ "${local_object_name}" = "${nothing}" ]; then
        # deleting remote ref: no checks
        continue
    fi

    if [ "${remote_object_name}" != "${nothing}" ]; then
        reference="${remote_object_name}"
    else
        reference="origin" # matches any branch on origin
    fi

    for commit in $(git rev-list "${local_object_name}" --not "${reference}"); do
        subject="$(git show --no-patch --format='%h %s' "${commit}" --)"
        out="$("${post_commit_hook}" "${commit}" | sed 's/^/    /')"

        if [ -n "${out}" ]; then
            fmt=" - ${red}%s${grey}:\n%s\n"
            fail=1
        else
            fmt=" - ${green}%s${grey}: ${green}pass${grey}%s\n"
        fi

        printf "${fmt}" "${subject}" "${out}" >&2
    done
done

exit "${fail:-0}"
